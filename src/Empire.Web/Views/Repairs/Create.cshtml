@model CreateRepairViewModel
@{
    ViewData["Title"] = "Create Repair";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-plus me-2"></i>
        Create New Repair
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a asp-action="Index" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>
            Back to Repairs
        </a>
    </div>
</div>

@if (!string.IsNullOrEmpty(ViewBag.Error as string))
{
    <div class="alert alert-danger" role="alert">
        <i class="fas fa-exclamation-triangle me-2"></i>
        @ViewBag.Error
    </div>
}

<div class="row">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-info-circle me-2"></i>
                    Repair Information
                </h6>
            </div>
            <div class="card-body">
                <form asp-action="Create" method="post">
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="CustomerId" class="form-label"></label>
                            <select asp-for="CustomerId" id="CustomerId" class="form-select" asp-items="ViewBag.Customers">
                                <option value="">Select Customer</option>
                            </select>
                            <span asp-validation-for="CustomerId" class="text-danger"></span>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="BrandId" class="form-label">Brand</label>
                            <select asp-for="BrandId" id="BrandId" name="BrandId" class="form-select">
                                <option value="">Select Brand</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Device Category and Model Selection -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="DeviceCategoryId" class="form-label">Device Category</label>
                            <select asp-for="DeviceCategoryId" id="DeviceCategoryId" class="form-select">
                                <option value="">Select Category</option>
                            </select>
                            <span asp-validation-for="DeviceCategoryId" class="text-danger"></span>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="DeviceModelId" class="form-label">Device Model</label>
                            <select asp-for="DeviceModelId" id="DeviceModelId" class="form-select" disabled>
                                <option value="">Select Model</option>
                            </select>
                            <span asp-validation-for="DeviceModelId" class="text-danger"></span>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="Issue" class="form-label"></label>
                        <input asp-for="Issue" class="form-control" list="issueList" placeholder="Brief description of the issue">
                        <datalist id="issueList">
                            <option value="Screen replacement" />
                            <option value="Battery replacement" />
                            <option value="Charging port replacement" />
                            <option value="Back glass" />
                            <option value="Phone service" />
                        </datalist>
                        <span asp-validation-for="Issue" class="text-danger"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label asp-for="Description" class="form-label"></label>
                        <textarea asp-for="Description" class="form-control" rows="3" 
                                  placeholder="Detailed description of the problem and diagnosis"></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>
                    

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label asp-for="Cost" class="form-label"></label>
                            <div class="input-group">
                                <span class="input-group-text">$</span>
                                <input asp-for="Cost" class="form-control" placeholder="0.00" step="0.01">
                            </div>
                            <span asp-validation-for="Cost" class="text-danger"></span>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label asp-for="PaymentStatus" class="form-label"></label>
                            <select asp-for="PaymentStatus" class="form-select">
                                <option value="Unpaid">Unpaid</option>
                                <option value="Paid">Paid</option>
                            </select>
                            <span asp-validation-for="PaymentStatus" class="text-danger"></span>
                        </div>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a asp-action="Index" class="btn btn-outline-secondary me-md-2">
                            Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-1"></i>
                            Create Repair
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-info">
                    <i class="fas fa-lightbulb me-2"></i>
                    Quick Tips
                </h6>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Default Status:</strong> New repairs start as "In Progress"
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Payment Status:</strong> Choose Paid or Unpaid
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Comments:</strong> Optional field for additional notes
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success me-2"></i>
                        <strong>Auto-Generated:</strong> Repair number is created automatically
                    </li>
                </ul>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header">
                <h6 class="m-0 font-weight-bold text-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Important Notes
                </h6>
            </div>
            <div class="card-body">
                <p class="small text-muted mb-2">
                    Make sure to select the correct customer and device before creating the repair.
                </p>
                <p class="small text-muted mb-0">
                    You can update the repair status and add more details after creation.
                </p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Initialize Select2 for dropdowns
            $('#CustomerId, #DeviceCategoryId, #DeviceModelId').select2({
                theme: 'bootstrap-5',
                allowClear: true,
                placeholder: function() {
                    return $(this).data('placeholder') || $(this).find('option:first').text();
                }
            });
            
            // Load initial data
            loadBrands();
            loadDeviceCategories();
            
            // Setup cascading dropdown logic
            setupCascadingDropdowns();
        });
        
        function loadBrands() {
            var url = '@Url.Action("GetBrands", "Repairs")';
            $.get(url, function(response) {
                if (response.success) {
                    const brandSelect = $('#BrandId');
                    brandSelect.empty().append('<option value="">Select Brand</option>');
                    
                    response.data.forEach(function(brand) {
                        brandSelect.append('<option value="' + brand.id + '">' + brand.name + '</option>');
                    });
                    
                    // Initialize Select2 for brand dropdown
                    brandSelect.select2({
                        theme: 'bootstrap-5',
                        placeholder: 'Select Brand'
                    });
                    
                    console.log('Loaded ' + response.data.length + ' brands');
                } else {
                    console.error('Failed to load brands:', response.message);
                }
            }).fail(function(xhr, status, error) {
                console.error('Error loading brands:', error);
            });
        }
        
        function loadDeviceCategories() {
            var url = '@Url.Action("GetDeviceCategories", "Repairs")';
            $.get(url, function(response) {
                if (response.success) {
                    const categorySelect = $('#DeviceCategoryId');
                    categorySelect.empty().append('<option value="">Select Category</option>');
                    
                    response.data.forEach(function(category) {
                        categorySelect.append('<option value="' + category.id + '">' + category.name + '</option>');
                    });
                    
                    // Refresh Select2 after updating options
                    categorySelect.trigger('change.select2');
                    console.log('Loaded ' + response.data.length + ' device categories');
                } else {
                    console.error('Failed to load device categories:', response.message);
                }
            }).fail(function(xhr, status, error) {
                console.error('Error loading device categories:', error);
            });
        }
        
        function loadDeviceModels(categoryId, brandId) {
            const modelSelect = $('#DeviceModelId');
            
            if (!categoryId) {
                modelSelect.empty().append('<option value="">Select Model</option>').prop('disabled', true);
                modelSelect.trigger('change.select2');
                return;
            }
            
            var url = '@Url.Action("GetDeviceModels", "Repairs")';
            var params = { categoryId: categoryId };
            if (brandId) {
                params.brandId = brandId;
            }
            $.get(url, params, function(response) {
                if (response.success) {
                    modelSelect.empty().append('<option value="">Select Model</option>');
                    
                    response.data.forEach(function(model) {
                        modelSelect.append('<option value="' + model.id + '">' + model.name + '</option>');
                    });
                    
                    modelSelect.prop('disabled', response.data.length === 0);
                    modelSelect.trigger('change.select2');
                    console.log('Loaded ' + response.data.length + ' device models for category ' + categoryId);
                } else {
                    console.error('Failed to load device models:', response.message);
                    modelSelect.empty().append('<option value="">Select Model</option>').prop('disabled', true);
                    modelSelect.trigger('change.select2');
                }
            }).fail(function(xhr, status, error) {
                console.error('Error loading device models:', error);
                modelSelect.empty().append('<option value="">Select Model</option>').prop('disabled', true);
                modelSelect.trigger('change.select2');
            });
        }
        
        function setupCascadingDropdowns() {
            // Brand change -> load models
            $('#BrandId').change(function() {
                const brandId = $(this).val();
                const categoryId = $('#DeviceCategoryId').val();
                if (brandId && categoryId) {
                    loadDeviceModels(categoryId, brandId);
                } else {
                    // Clear models if brand is cleared
                    $('#DeviceModelId').empty().append('<option value="">Select Model</option>');
                }
            });
            
            // Category change -> load models
            $('#DeviceCategoryId').change(function() {
                const categoryId = $(this).val();
                const brandId = $('#BrandId').val();
                if (categoryId && brandId) {
                    loadDeviceModels(categoryId, brandId);
                } else {
                    // Clear models if category is cleared
                    $('#DeviceModelId').empty().append('<option value="">Select Model</option>');
                }
            });
        }
    </script>
}


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Empire Solution</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <style>
        .sidebar {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .sidebar .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 0.75rem 1rem;
            margin: 0.25rem 0;
            border-radius: 0.5rem;
            transition: all 0.3s ease;
        }
        .sidebar .nav-link:hover,
        .sidebar .nav-link.active {
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }
        .main-content {
            background-color: #f8f9fa;
            min-height: 100vh;
        }
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .stat-card-success {
            background: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
        }
        .stat-card-warning {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .stat-card-info {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .navbar-brand {
            font-weight: bold;
            font-size: 1.5rem;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
            transform: translateY(-1px);
        }
        .table th {
            background-color: #f8f9fa;
            border-top: none;
            font-weight: 600;
        }
        .badge {
            font-size: 0.75em;
            padding: 0.5em 0.75em;
        }
    </style>
    @await RenderSectionAsync("Styles", required: false)
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            @if (Context.Session.GetString("UserId") != null)
            {
                <!-- Sidebar -->
                <nav class="col-md-3 col-lg-2 d-md-block sidebar collapse">
                    <div class="position-sticky pt-3">
                        <div class="text-center mb-4">
                            <h4 class="text-white">
                                <i class="fas fa-mobile-alt me-2"></i>
                                Empire Solution
                            </h4>
                            <small class="text-white-50">Phone Repair Management</small>
                        </div>
                        
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link @(ViewContext.RouteData.Values["Action"]?.ToString() == "Dashboard" ? "active" : "")" 
                                   asp-controller="Home" asp-action="Dashboard">
                                    <i class="fas fa-tachometer-alt me-2"></i>
                                    Dashboard
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString() == "Repairs" ? "active" : "")" 
                                   asp-controller="Repairs" asp-action="Index">
                                    <i class="fas fa-tools me-2"></i>
                                    Repairs
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString() == "Inventories" ? "active" : "")" 
                                   asp-controller="Inventories" asp-action="Index">
                                    <i class="fas fa-boxes me-2"></i>
                                    Inventory
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString() == "Devices" ? "active" : "")" 
                                   asp-controller="Devices" asp-action="Index">
                                    <i class="fas fa-mobile-alt me-2"></i>
                                    Devices
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="@Url.Action("Index", "Customers")">
                                    <i class="fas fa-users me-2"></i>
                                    Customers
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString() == "POS" ? "active" : "")" 
                                   asp-controller="POS" asp-action="Index">
                                    <i class="fas fa-cash-register me-2"></i>
                                    Point of Sale
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link disabled" href="#" title="Coming Soon">
                                    <i class="fas fa-chart-bar me-2"></i>
                                    Reports
                                    <small class="text-muted">(Coming Soon)</small>
                                </a>
                            </li>
                        </ul>
                        
                        <hr class="my-3" style="border-color: rgba(255, 255, 255, 0.2);">
                        
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString() == "LookupManagement" ? "active" : "")" 
                                   asp-controller="LookupManagement" asp-action="Index">
                                    <i class="fas fa-cogs me-2"></i>
                                    Lookup Management
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString() == "Shop" ? "active" : "")" 
                                   asp-controller="Shop" asp-action="Index">
                                    <i class="fas fa-store me-2"></i>
                                    Shops
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link @(ViewContext.RouteData.Values["Controller"]?.ToString() == "Users" ? "active" : "")" 
                                   asp-controller="Users" asp-action="Index">
                                    <i class="fas fa-user-cog me-2"></i>
                                    Users
                                </a>
                            </li>
                        </ul>
                        
                        <hr class="my-3" style="border-color: rgba(255, 255, 255, 0.2);">
                        
                        <div class="text-white-50 small px-3">
                            <div><strong>@Context.Session.GetString("UserName")</strong></div>
                            <div>@Context.Session.GetString("CurrentShopName")</div>
                            <div class="badge bg-light text-dark mt-1">@Context.Session.GetString("UserRole")</div>
                        </div>
                        
                        <div class="mt-3 px-3">
                            <form asp-controller="Home" asp-action="Logout" method="post">
                                <button type="submit" class="btn btn-outline-light btn-sm w-100">
                                    <i class="fas fa-sign-out-alt me-2"></i>
                                    Logout
                                </button>
                            </form>
                        </div>
                    </div>
                </nav>
                
                <!-- Main content -->
                <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 main-content">
                    <div class="pt-3 pb-2 mb-3">
                        @RenderBody()
                    </div>
                </main>
            }
            else
            {
                <!-- Full width for login page -->
                <main class="col-12">
                    @RenderBody()
                </main>
            }
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.print.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
        <script>
        // Initialize DataTables for all tables with class 'data-table'
        $(document).ready(function() {
            $('.data-table').DataTable({
                responsive: true,
                pageLength: 25
            });
        });

        // Global Select2 initialization function
        function initializeSelect2(selector, options = {}) {
            const defaultOptions = {
                theme: 'bootstrap-5',
                width: '100%',
                placeholder: 'Select an option...',
                allowClear: true,
                dropdownParent: options.dropdownParent || $('body')
            };
            
            const finalOptions = { ...defaultOptions, ...options };
            $(selector).select2(finalOptions);
        }

        // Initialize all select elements with Select2 on page load
        $(document).ready(function() {
            // Initialize all select elements that don't have the 'no-select2' class
            $('select:not(.no-select2)').each(function() {
                const $select = $(this);
                const placeholder = $select.attr('data-placeholder') || 'Select an option...';
                
                initializeSelect2($select, {
                    placeholder: placeholder,
                    allowClear: !$select.prop('required')
                });
            });
        });
    </script>
    
    <!-- Customer Selection Script -->
    <script>
        // Global customer selection functionality
        function loadCustomerSelectionModal() {
            if ($('#customerSelectionModal').length === 0) {
                // Load customer selection modal from customers page
                $.get('@Url.Action("Index", "Customers")', function(data) {
                    const modalHtml = $(data).find('#customerSelectionModal').prop('outerHTML');
                    if (modalHtml) {
                        $('body').append(modalHtml);
                        
                        // Re-bind customer search functionality
                        $('#customerSearchInput').on('input', function() {
                            searchCustomersGlobal($(this).val());
                        });
                    }
                });
            }
        }
        
        function searchCustomersGlobal(searchTerm) {
            $.ajax({
                url: '@Url.Action("GetCustomersForSelection", "Customers")',
                type: 'GET',
                success: function(response) {
                    if (response.success) {
                        let filteredCustomers = response.customers;
                        if (searchTerm) {
                            filteredCustomers = response.customers.filter(c => 
                                c.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                                c.phone.includes(searchTerm)
                            );
                        }
                        displayCustomerSearchResultsGlobal(filteredCustomers);
                    }
                },
                error: function() {
                    console.error('Error loading customers');
                }
            });
        }

        function displayCustomerSearchResultsGlobal(customers) {
            const resultsContainer = $('#customerSearchResults');
            resultsContainer.empty();

            customers.forEach(function(customer) {
                const item = $(`
                    <a href="#" class="list-group-item list-group-item-action" onclick="selectCustomerGlobal(${customer.id}, '${customer.name}')">
                        <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">${customer.name}</h6>
                            <small>${customer.phone}</small>
                        </div>
                        ${customer.email ? '<small>' + customer.email + '</small>' : ''}
                    </a>
                `);
                resultsContainer.append(item);
            });

            if (customers.length === 0) {
                resultsContainer.html('<div class="text-center text-muted">No customers found</div>');
            }
        }

        function selectCustomerGlobal(id, name) {
            $('#customerSelectionModal').modal('hide');
            if (window.customerSelectionCallback) {
                window.customerSelectionCallback(id, name);
            }
        }
        
        // Make customer selection available globally
        window.showCustomerSelection = function(callback) {
            window.customerSelectionCallback = callback;
            loadCustomerSelectionModal();
            setTimeout(function() {
                $('#customerSelectionModal').modal('show');
                searchCustomersGlobal(''); // Load all customers initially
            }, 100);
        };
        
        // Load customer selection modal on page load
        $(document).ready(function() {
            loadCustomerSelectionModal();
        });
    </script>
    

    <script>
        // Define printDevice globally
        window.printDevice = function(deviceId) {
            console.log("Print device:", deviceId);
            $.get("@Url.Action("GetDetails", "Devices")" + deviceId)
                .done(function(response) {
                    if (!response.success) {
                        alert("Error loading device data: " + response.message);
                        return;
                    }
                    const device = response.device;
                    const printContent = createDevicePrintContent(device);
                    const printWindow = window.open("", "_blank", "width=800,height=600");
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.onload = function() {
                        printWindow.print();
                        printWindow.close();
                    };
                })
                .fail(function(xhr, status, error) {
                    console.error("Failed to load device data for printing:", error);
                    alert("Failed to load device data for printing. Please try again.");
                });
        };

        // Define createDevicePrintContent globally as well, as it\'s a dependency
        window.createDevicePrintContent = function(device) {
            const currentDate = new Date().toLocaleDateString();
            const statusText = device.IsSold ? "Sold" : (device.IsAvailableForSale ? "Available for Sale" : "Not for Sale");
            return `
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Device Label - ${device.Brand} ${device.Model}</title>
                    <style>
                        body {
                            font-family: Arial, sans-serif;
                            margin: 20px;
                            background: white;
                        }
                        .device-label {
                            border: 2px solid #333;
                            padding: 20px;
                            max-width: 600px;
                            margin: 0 auto;
                            background: white;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 2px solid #333;
                            padding-bottom: 15px;
                            margin-bottom: 20px;
                        }
                        .company-name {
                            font-size: 24px;
                            font-weight: bold;
                            color: #333;
                            margin-bottom: 5px;
                        }
                        .device-title {
                            font-size: 20px;
                            font-weight: bold;
                            color: #666;
                        }
                        .device-info {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 15px;
                            margin-bottom: 20px;
                        }
                        .info-item {
                            display: flex;
                            justify-content: space-between;
                            padding: 8px 0;
                            border-bottom: 1px solid #eee;
                        }
                        .info-label {
                            font-weight: bold;
                            color: #333;
                        }
                        .info-value {
                            color: #666;
                        }
                        .status-section {
                            text-align: center;
                            padding: 15px;
                            margin: 20px 0;
                            border: 2px solid #ddd;
                            background-color: #f9f9f9;
                        }
                        .status-available {
                            border-color: #28a745;
                            background-color: #d4edda;
                            color: #155724;
                        }
                        .status-sold {
                            border-color: #dc3545;
                            background-color: #f8d7da;
                            color: #721c24;
                        }
                        .status-not-for-sale {
                            border-color: #6c757d;
                            background-color: #e2e3e5;
                            color: #383d41;
                        }
                        .price-section {
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 20px;
                            margin: 20px 0;
                        }
                        .price-box {
                            text-align: center;
                            padding: 15px;
                            border: 2px solid #333;
                            background-color: #f8f9fa;
                        }
                        .price-label {
                            font-size: 14px;
                            font-weight: bold;
                            color: #666;
                            margin-bottom: 5px;
                        }
                        .price-value {
                            font-size: 24px;
                            font-weight: bold;
                            color: #333;
                        }
                        .footer {
                            text-align: center;
                            margin-top: 20px;
                            padding-top: 15px;
                            border-top: 1px solid #ddd;
                            font-size: 12px;
                            color: #666;
                        }
                        .qr-placeholder {
                            width: 80px;
                            height: 80px;
                            border: 2px solid #333;
                            margin: 10px auto;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            font-size: 10px;
                            color: #666;
                        }
                        @@media print {
                            body { margin: 0; }
                            .device-label { 
                                border: 2px solid #000;
                                max-width: none;
                                margin: 0;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="device-label">
                        <div class="header">
                            <div class="company-name">Empire Solution</div>
                            <div class="device-title">${device.Brand} ${device.Model}</div>
                        </div>
                        
                        <div class="device-info">
                            <div class="info-item">
                                <span class="info-label">Brand:</span>
                                <span class="info-value">${device.Brand || "N/A"}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Model:</span>
                                <span class="info-value">${device.Model || "N/A"}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Category:</span>
                                <span class="info-value">${device.Category || "N/A"}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">IMEI/Serial:</span>
                                <span class="info-value">${device.IMEISerialNumber || "N/A"}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Network:</span>
                                <span class="info-value">${device.NetworkStatus || "N/A"}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Battery:</span>
                                <span class="info-value">${device.BatteryHealthPercentage ? device.BatteryHealthPercentage + "%" : "N/A"}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Condition:</span>
                                <span class="info-value">${device.ScratchesCondition || "N/A"}</span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Year:</span>
                                <span class="info-value">${device.Year || "N/A"}</span>
                            </div>
                        </div>

                        <div class="status-section ${device.IsSold ? "status-sold" : (device.IsAvailableForSale ? "status-available" : "status-not-for-sale")}">
                            <h3 style="margin: 0; font-size: 18px;">STATUS: ${statusText.toUpperCase()}</h3>
                        </div>

                        <div class="price-section">
                            <div class="price-box">
                                <div class="price-label">BUYING PRICE</div>
                                <div class="price-value">${device.BuyingPrice ? "$" + device.BuyingPrice.toFixed(2) : "N/A"}</div>
                            </div>
                            <div class="price-box">
                                <div class="price-label">SELLING PRICE</div>
                                <div class="price-value">${device.SellingPrice ? "$" + device.SellingPrice.toFixed(2) : "N/A"}</div>
                            </div>
                        </div>

                        ${device.Notes ? `
                        <div style="margin: 15px 0; padding: 10px; background-color: #f8f9fa; border-left: 4px solid #007bff;">
                            <strong>Notes:</strong> ${device.Notes}
                        </div>
                        ` : ""}

                        <div class="qr-placeholder">
                            QR CODE
                        </div>

                        <div class="footer">
                            <div>Device ID: ${device.Id} | Printed: ${currentDate}</div>
                            <div style="margin-top: 5px;">Empire Solution - Device Management System</div>
                        </div>
                    </div>
                </body>
                </html>
            `;
        };
    </script>
    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>

